name: SSH over Tailscale (Root Access)

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    # 使用 Linux Runner (基于 Debian/Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    
    steps:
      - name: 1. 配置核心 SSH 设置 (允许 Root 登录)
        run: |
          # 确保 SSH 服务已运行
          sudo apt update
          sudo apt install -y openssh-server
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          # 修改 SSH 配置文件以允许 root 用户远程登录
          # 将 PermitRootLogin 设置为 yes
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
          sudo sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
          
          # 重启 SSH 服务以应用更改
          sudo systemctl restart ssh

      - name: 2. 设置 Root 用户密码 (使用 GitHub Secret)
        shell: bash
        run: |
          PASSWORD_SECRET="${{ secrets.RDP_USER_PASSWORD }}"
          
          # 使用 'chpasswd' 命令将 Secret 中的密码设置为 root 用户的密码
          # 注意：此密码需要满足 Windows/Linux 系统的复杂性要求
          echo "root:$PASSWORD_SECRET" | sudo chpasswd
          
          echo "Root 用户密码已设置并允许 SSH 登录。"
          
          # 额外的安全检查（非必须，但推荐）
          if ! sudo grep -q "PermitRootLogin yes" /etc/ssh/sshd_config; then
              echo "错误：SSH 配置修改失败，Root 登录可能仍被禁止。"
              exit 1
          fi

      - name: 3. 安装 Tailscale
        run: |
          sudo apt update
          sudo apt install -y curl
          
          # 添加 Tailscale 的 GPG 密钥和仓库
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt update
          sudo apt install -y tailscale

      - name: 4. 建立 Tailscale 连接
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          
          # 等待 Tailscale 分配 IP
          TS_IP=""
          for i in $(seq 1 10); do
              TS_IP=$(sudo tailscale ip -4)
              if [ -n "$TS_IP" ]; then
                  break
              fi
              sleep 5
          done
          
          if [ -z "$TS_IP" ]; then
              echo "Tailscale IP 未分配。退出。"
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      
      - name: 5. 验证 SSH 可访问性
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # 安装 netcat 并测试 SSH 端口连通性
          sudo apt install -y netcat-openbsd
          if nc -z -w 5 $TAILSCALE_IP 22; then
              echo "TCP 连接到 SSH 端口 22 成功！"
          else
              echo "错误: TCP 连接到 SSH 端口 22 失败"
              exit 1
          fi

      - name: 6. 保持连接 (Maintain Connection)
        run: |
          echo -e "\n=== SSH 访问信息 ==="
          echo "协议: SSH (Root 权限)"
          echo "地址 (Tailscale IP): $TAILSCALE_IP"
          echo "用户名: root" # 更改为 root
          echo "密码: 请使用您在 GitHub Secrets 中设置的 RDP_USER_PASSWORD。"
          echo -e "连接命令示例: ssh root@$TAILSCALE_IP" # 连接命令更改为 root
          echo -e "====================\n"
          
          while true; do
              echo "[$(date)] SSH 活跃中 (Root Access) - 在工作流页面手动点击 Cancel 终止"
              sleep 300
          done
